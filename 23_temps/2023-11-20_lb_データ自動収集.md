## アメーバ経営ダッシュボード
### マイルストーン
| ver | タイトル  | 内容 |
| --- | --- | --- |
| ✅v2.0.0 | 案件粗利の評価 | 手動でデータを投入すれば案件粗利を評価できる<br /> リリース予定 |
| 📌v2.0.1 | 案件粗利のデータ自動収集 | データの自動収集範囲を広げる<br />どこまでの精度にするかは進捗との兼ね合いで調整する |
| v2.0.2 | 案件粗利の評価の見た目向上 | グラフ, 内訳の整理など表示内容が直観的にわかるように売上原価の細目タイプを設定する<br /> （範囲外だったはずだけども..作ってみたら欲しくなったので提案。ただし、v2.0.4のあとでもいいかも？） |
| v2.0.3 | 人の貢献度の評価 | 案件粗利のデータを使って、スタッフの貢献度を評価する |
| v2.0.4 | チームの貢献度の評価 | スタッフの貢献度を合計して、チームの貢献度を評価する |
| v2.0.5 | クライアント, エージェントの粗利率の評価 | |
| --- | --- | --- |
| v2.0.a | 粗利の精度向上 | +-15%のイメージ |
| v2.0.b | スナップショットができるまでの処置 | ... |
| v2.0.c | スナップショット | ... |

### 会議中の指摘や追加事項
- ...
- ...


### メモ
- 薄く中途半端にするか、案件管理をきちんとやるか？
- 案件管理をきちんやったほうがいい理由
  - 案件の粗利率をなるべく精度高めたほうがいいよね？
  - 1月中から制度として始めるはいい
  - 12月は案件を終わらせましょう
    - 案件の収益がわかれば、評価はできる（誰が参画してたか？はわかるはずだから）
- 薄く中途半端
  - 案件の粗利率適当で、人・チームの評価できるんだっけ？


### v2.0.1 案件粗利のデータ自動収集
- Program(案件)
  - 📌案件の締め処理(誰かが締めると、解除できない仕組み？それとも全員Approveされたら締め？)
- fetch
  - from lbe_system:
    - 📌締め処理された案件だけを取得する
  - from kintone:
    - ✅売上高取得保存済み
    - 📌Participant を取得する
  - from mf経費:
    - ✅経費情報取得保存済み
  - ✅from mf経費の事前申請の振込依頼
  - ✅from GSheet
- Sync
  - Manage::Programの精緻化
    - ✅event_dateの追加
    - ✅kintone_codeの一意制約
  - DirectCostの精緻化
    - ✅MFのページ対応
    - ✅DirectCostの一意制約をつける
    - ✅LbEシステムから収集するデータ項目を確認する
    - ✅税抜き価格の計算と保存（端数は、切り下げ）
    - ✅MFのAdvancedPaymentを同期させない
    - ✅MF経費からは、勘定科目を同期させる
    - ✅google sheetからの売上原価の登録
- Analitics
  - 📌参加者売上単価＝売上／参加者数 を計算して、どこかに保存して、表示する
  - 📌参加者利益単価＝粗利／参加者数 を計算して、どこかに保存して、表示する
- 不具合
  - ✅kintone_codeを更新したときに、データ不整合が発生する

### v2.0.2 案件粗利の評価の見た目向上
- ✅案件を月別で絞り込み表示する？
- 🤔表示項目の調整
- 🤔売上原価の項目やまとめかた
- 🤔MF経費の従業員と、LbESystemの従業員を、member_idで紐付ける？

### v2.0.3 人の貢献度の評価
- 仕様検討
  - 🤔kintone上での従業員と、LbE_System上での従業員をどのように一致させるか？（名前は揺れそう）
- fetch
  - 📌kintoneの従業員を収集する（kintone上での仕様も検討が必要そう, lbe_system上での従業員IDをもたせるとか）
  - 📌kintoneの従業員の貢献度を収集する（kintone上での仕様も検討が必要そう）
- sync
  - 📌従業員の同期
  - 📌貢献度の同期
  - 📌「案件と従業員と貢献度」を紐付ける同期
- 表示
  - 🙏📌案件の表示と同様

### v2.0.4 チームの貢献度の評価
- 仕様検討
  - 🤔kintone上で、チームの管理、チームと従業員の紐づけをどのように管理するか？
  - 🤔kintone上での情報と、LbE_System上での情報をどのように一致させるか？
- fetch
  - 📌kintoneのチームを収集する
  - 📌kintoneのチームと従業員の関係性を収集する
- sync
  - 📌チームの同期
  - 📌チームと従業員の関係性の同期
- 表示
  - 📌案件・人の表示と同様

### v2.0.5 クライアント, エージェントの粗利率の評価
- （ほとんど、同上のはず）

### v2.0.a 粗利の精度向上
- なし

### v2.0.b スナップショットができるまでの処置
- 📌同期期間を指定することで、過去の情報を上書きしないようにする
  - （この方法でも、貢献度マスタを持つ場合には、貢献度マスタが更新されることで、過去の貢献度は変わってしまいます）

### v2.0.c スナップショット
- 📌同期するたびに、その時点の情報をスナップショットとして保存する
- 📌すべての画面、すべてのモデルを複製する

## 作業メモ
### from mf経費の事前申請の振込依頼
- 事業者全体の申請リストを返す
  - https://expense.moneyforward.com/api/index.html#/ex_report/find_office_ex_reports
  - uri
    - /api/external/v1/offices/{office_id}/ex_reports
  - method
    - GET
  - params
    - office_id *
    - page

### TODO
- ✅APIの試し打ち
- ✅Choron::Moneyforward::Client
  - ✅ex_reports_client
  - ✅Choron::Moneyforward::Private::EXReportsClient
  - ✅Lbe::Moneyforward::Values::ExReports::TransferRequest
  - ✅be::Moneyforward::Client#ex_reports
- ✅Fetch
- Sync
  - ✅申請からの売上原価の同期


## MoneyForwardのAPI
https://expense.moneyforward.com/api/index.html#/

```rb
moneyforward = SystemSettings::Moneyforward.latest
credentials = moneyforward.to_credentials
client = Lbe::Moneyforward::Client.new(Rails.env.to_sym, credentials:)

from = Time.zone.parse('2023-10-29')
to = Time.zone.parse('2023-10-29')
expenses = client.expenses(from:, to:)

```

## 実行可能なCURLコマンド
### /api/external/v1/offices/{office_id}/ex_transactions
```
curl -X GET 'https://expense.moneyforward.com/api/external/v1/offices/J4t2gsevoIFChzioLajXeA/ex_transactions?query_object%5Brecognized_at_from%5D=2023-10-29&query_object%5Brecognized_at_to%5D=2023-10-29' \
> -H 'Authorization: Bearer WSAUQ1-pLr-s3LAbp3DKYWE7L2fmlbMQ_AgS-6vlYO0' \
> -H 'User-Agent: HTTPClient/1.0 (2.8.3, ruby 3.2.0 (2022-12-25))' \
> -H 'Accept: */*' \
> -H 'Date: Fri, 08 Dec 2023 02:41:15 GMT' \
> -H 'Host: expense.moneyforward.com'
```

### /api/external/v1/offices/{office_id}/ex_reports
```sh
curl -X GET 'https://expense.moneyforward.com/api/external/v1/offices/J4t2gsevoIFChzioLajXeA/ex_reports?query_object%5Brecognized_at_from%5D=2023-11-21&query_object%5Brecognized_at_to%5D=2023-11-22' \
-H 'Authorization: Bearer WSAUQ1-pLr-s3LAbp3DKYWE7L2fmlbMQ_AgS-6vlYO0' \
-H 'User-Agent: HTTPClient/1.0 (2.8.3, ruby 3.2.0 (2022-12-25))' \
-H 'Accept: */*' \
-H 'Date: Fri, 08 Dec 2023 02:41:15 GMT' \
-H 'Host: expense.moneyforward.com'
```

```sh
curl -X GET 'https://expense.moneyforward.com/api/external/v1/offices/J4t2gsevoIFChzioLajXeA/ex_reports?page=3' \
-H 'Authorization: Bearer WSAUQ1-pLr-s3LAbp3DKYWE7L2fmlbMQ_AgS-6vlYO0' \
-H 'User-Agent: HTTPClient/1.0 (2.8.3, ruby 3.2.0 (2022-12-25))' \
-H 'Accept: */*' \
-H 'Date: Fri, 08 Dec 2023 02:41:15 GMT' \
-H 'Host: expense.moneyforward.com'
```



